<!DOCTYPE html>
<html>
<head>
<link rel="Stylesheet" type="text/css" href="style.css">
<title>freebsd_backup</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<div id="Bepo"><h1 id="Bepo" class="header"><a href="#Bepo">Bepo</a></h1></div>

<p>
Récupérer le fichier <a href="http://download.tuxfamily.org/dvorak/devel/fr-dvorak-bepo-kbdmap-1.0rc2.tgz">http://download.tuxfamily.org/dvorak/devel/fr-dvorak-bepo-kbdmap-1.0rc2.tgz</a>
</p>

<p>
&lt;syntaxhighlight lang="shell"&gt;mv /home/alex/Downloads/fr-dvorak-bepo-kbdmap-1.0rc2/fr-dvorak-bepo.kbd //usr/share/vt/keymaps/fr.dvorak.bepo&lt;/syntaxhighlight&gt;
</p>
<div id="rc.conf"><h1 id="rc.conf" class="header"><a href="#rc.conf">rc.conf</a></h1></div>

<p>
/etc/rc.conf
</p>

<p>
&lt;syntaxhighlight lang="shell"&gt;hostname="ecchi"
keymap="fr.dvorak.bepo" # Uses vt so in /usr/share/vt/keymaps
ifconfig_re0="DHCP"
</p>
<ol>
<li>
Static IP to be connectable in MAM

</ol>
<p>
#ifconfig_re0="inet 192.168.1.90 netmask 255.255.255.0"
#defaultrouter="192.168.1.254" # found by the first list on netstat -r
sshd_enable="YES"
ntpd_enable="YES"
powerd_enable="YES"
</p>
<ol>
<li>
Dbus

</ol>
<p>
sysrc_dbus_enable="YES"
hald_enable="YES" # For kobo
</p>
<ol>
<li>
Set dumpdev to "AUTO" to enable crash dumps, "NO" to disable

</ol>
<p>
dumpdev="AUTO"
zfs_enable="YES"
kld_list="nvidia-modeset"
</p>
<ol>
<li>
Cups

</ol>
<p>
cupsd_enable="YES"
devfs_system_ruleset="system"
musicpd_enable="YES"
</p>
<ol>
<li>
Usenet

</ol>
<p>
nzbget_enable="YES"
nzbhydra2_enable="YES"
</p>
<ol>
<li>
NFS for Kodi

<li>
Order is important : rpcbind first, then nfs and mountd

</ol>
<p>
rpcbind_enable="YES"
nfs_server_enable="YES"
weak_mountd_authentication="yes"
mountd_enable="YES"
nfs_client_enable="YES"
dbus_enable="YES"
dbus_enable="YES"
fuse_load="YES"&lt;/syntaxhighlight&gt;
</p>
<div id="/etc/sysctl.conf"><h1 id="/etc/sysctl.conf" class="header"><a href="#/etc/sysctl.conf">/etc/sysctl.conf</a></h1></div>

<p>
&lt;pre&gt;# Allow users to mount
vfs.usermount=1&lt;/pre&gt;
</p>
<div id="/boot/loader.conf"><h1 id="/boot/loader.conf" class="header"><a href="#/boot/loader.conf">/boot/loader.conf</a></h1></div>

<p>
kern.geom.label.gptid.enable=&amp;quot;0&amp;quot; opensolaris<sub>load</sub>=&amp;quot;YES&amp;quot; openzfs<sub>load</sub>=&amp;quot;YES&amp;quot; vboxdrv<sub>load</sub>=&amp;quot;YES&amp;quot;
</p>

<p>
hw.usb.no<sub>bootwait</sub>=1
</p>

<div id="Brother printer"><h1 id="Brother printer" class="header"><a href="#Brother printer">Brother printer</a></h1></div>

<p>
/etc/devfs.rules :
</p>

<p>
&lt;pre&gt;[system=10]
add path 'unlpt*' mode 0660 group cups
add path 'ulpt*' mode 0660 group cups
add path 'lpt*' mode 0660 group cups
add path 'usb/1.3.0' mode 0660 group cups&lt;/pre&gt;
Installer brlaser et cups-filter
</p>

<div id="ZFS notes"><h1 id="ZFS notes" class="header"><a href="#ZFS notes">ZFS notes</a></h1></div>

<p>
OpenZFS est utilisation avec 12.2 mais ne pas mettre à jour le root avant la version 13 ! Par défaut, les autres pool ne sont pas importées donc il faut rajouter zfs import -a dans /etc/rc.d/zfs.
</p>

<div id="/etc/fstab"><h1 id="/etc/fstab" class="header"><a href="#/etc/fstab">/etc/fstab</a></h1></div>

<p>
&lt;syntaxhighlight lang="shell"&gt;# Device        Mountpoint               FStype Options     Dump    Pass#
/dev/ada0p2     none                 swap   sw      0       0
</p>
<ol>
<li>
Linux

</ol>
<p>
/dev/ada3p2         /linux-root          ext2fs  rw      0       0
/dev/ada3p4         /linux               ext2fs  rw      0       0
</p>
<ol>
<li>
For OpenJDK

</ol>
<p>
fdesc               /dev/fd              fdescfs rw      0       0
proc                /proc                procfs  rw      0       0
</p>
<ol>
<li>
Linux emulation

</ol>
<p>
linproc             /compat/linux/proc   linprocfs  rw, late      0       0
linsys              /compat/linux/sys    linsysfs rw,late     0       0
tmpfs               /compat/linux/dev/shm  tmpfs   rw,mode=1777    0       0
</p>
<ol>
<li>
Ubuntu jail

</ol>
<p>
devfs           /compat/ubuntu/dev      devfs           rw,late                      0       0
tmpfs           /compat/ubuntu/dev/shm  tmpfs           rw,late,size=1g,mode=1777    0       0
fdescfs         /compat/ubuntu/dev/fd   fdescfs         rw,late,linrdlnk             0       0
linprocfs       /compat/ubuntu/proc     linprocfs       rw,late                      0       0
linsysfs        /compat/ubuntu/sys      linsysfs        rw,late                      0       0
/tmp            /compat/ubuntu/tmp      nullfs          rw,late                      0       0
/home           /compat/ubuntu/home     nullfs          rw,late                      0       0&lt;/syntaxhighlight&gt;
</p>
<div id="xorg (nvidia)"><h1 id="xorg (nvidia)" class="header"><a href="#xorg (nvidia)">xorg (nvidia)</a></h1></div>

<p>
/usr/local/etc/X11/xorg.conf.d/driver-nvidia.conf
</p>

<p>
&lt;syntaxhighlight lang="shell"&gt;Section "Device"
</p>
<blockquote>
Identifier "NVIDIA card"
Driver "nvidia"
</blockquote>
<p>
EndSection&lt;/syntaxhighlight&gt;
</p>
<div id="nzbget"><h1 id="nzbget" class="header"><a href="#nzbget">nzbget</a></h1></div>

<p>
Cf backups nzbget.conf
</p>

<div id="nzbhydra"><h1 id="nzbhydra" class="header"><a href="#nzbhydra">nzbhydra</a></h1></div>

<p>
Copying indexers must be done by hand… Cf backups /usr/local/nzbhydra2/nzbhydra.yml
</p>

<div id="crontab"><h1 id="crontab" class="header"><a href="#crontab">crontab</a></h1></div>

<p>
&lt;syntaxhighlight lang="shell"&gt;MAILTO=""
*/5 *   *   *   *   /bin/sh /usr/home/alex/scripts/mbsync_notmuch.sh
0   */3 *   *   *   /usr/local/bin/fish /usr/home/alex/backups/backup.fish
0 * * * * DISPLAY=:0 $HOME/projects/simple-dwall/simple-dwall.fish
@reboot /usr/local/bin/tmux new-session -d -s rtorrent '/usr/local/bin/rtorrent'
@reboot /usr/local/bin/emacs --daemon
&lt;/syntaxhighlight&gt;
</p>
<div id="backup"><h1 id="backup" class="header"><a href="#backup">backup</a></h1></div>

<p>
&lt;pre&gt;#!/usr/local/bin/fish
</p>
<ol>
<li>
3 steps procedure :

<li>
  1. Backup from the pi using rsync

<li>
  2. Encrypt cofig files (rasperry + local) using duplicity

<li>
  2. Backup to the cloud using rsync

</ol>
<p>
#
</p>
<ol>
<li>
Backup data either in clear or encrypted

<li>
- google -&amp;gt; to google drive (clear)

<li>
- hubic -&amp;gt; to Hubic and Mega(clear)

<li>
- local config files -&amp;gt; google and hubic (encrypted)

<li>
- raspberry config files -&amp;gt; google and hubic (encrypted)

<li>
- local rtorrent -&amp;gt; google and hubic (encrypted)

<li>
- raspberry rtorrent -&amp;gt; google and hubic (encrypted)

</ol>
<p>
set root &amp;quot;/home/alex/backups&amp;quot;
</p>

<ol>
<li>
Duplicity needs a passphrase. Use pass &amp;quot;backup/duplicity&amp;quot;

</ol>
<p>
set -x PASSPHRASE (cat /home/alex/.pass.txt)
</p>

<ol>
<li>
#------- Raspberry: backup -----

<li>
Save books

</ol>
<p>
rclone sync pi:/media/books/ /media/books/
</p>
<ol>
<li>
Save torrents and config files(encrypted)

<li>
Warning : --include implyies everything is excluded so we need /** at the end

<li>
Don't forget the / in the folder too..

</ol>
<p>
set tmp ~/backups/raspberry-tmp/
rclone sync --include &amp;quot;/home/alex/Downloads/torrents/**&amp;quot; \
</p>
<blockquote>
--include &amp;quot;/home/alex/Downloads/session/**&amp;quot; \
--include &amp;quot;/usr/local/etc/**&amp;quot;  \
--include &amp;quot;/etc/**&amp;quot;  \
--include &amp;quot;/boot/loader.conf&amp;quot;  pi:/ $tmp
</blockquote>
<ol>
<li>
Encrypt it

</ol>
<p>
duplicity $tmp <a href="file:///home/alex/backups/raspberry">file:///home/alex/backups/raspberry</a>
</p>

<p>
#------- Local backup (encrypted) ----------------
</p>
<ol>
<li>
1. Create encrypted local version

</ol>
<p>
#
</p>
<ol>
<li>
This requires setenv PASSPHRASE in doas.conf !!

<li>
Due to permission, we need separate folder for doas command

</ol>
<p>
doas duplicity --include /usr/local/etc/ --include /etc/ \
</p>
<blockquote>
--include /boot/loader.conf --exclude '**' \
/ <a href="file:///home/alex/backups/desktop/root">file:///home/alex/backups/desktop/root</a>
</blockquote>

<p>
duplicity --include /home/alex/Downloads/torrents \
</p>
<blockquote>
--include /home/alex/Downloads/session \
--exclude '**'  \
/home/alex/Downloads <a href="file:///home/alex/backups/desktop/rtorrent">file:///home/alex/backups/desktop/rtorrent</a>
</blockquote>

<p>
#------------ Backup all encnrypted and non encrypted
</p>

<ol>
<li>
Backup is then made with rsync because there is a symlink

<li>
desktop -&amp;gt; google/desktop

<li>
desktop -&amp;gt; hubic /desktop

</ol>
<p>
#--- All
</p>
<ol>
<li>
Google drive and mega can be managed with rclone

</ol>
<p>
rclone -L sync --exclude 'Coopétition/' --drive-import-formats .xlsx $root/google/  google:
rclone -L sync $root/google backblaze:unixStorage
rclone -L sync $root/hubic hubic:
rclone -L sync $root/hubic mega:
</p>

<p>
#--- Passphrase
/usr/local/bin/pass git push&lt;/pre&gt;
</p>
<div id="Sci-hub et DNS resolv.conf"><h1 id="Sci-hub et DNS resolv.conf" class="header"><a href="#Sci-hub et DNS resolv.conf">Sci-hub et DNS resolv.conf</a></h1></div>

<div id="Sci-hub et DNS resolv.conf-Sous linux"><h2 id="Sous linux" class="header"><a href="#Sci-hub et DNS resolv.conf-Sous linux">Sous linux</a></h2></div>

<p>
On edite directement /etc/resolv.conf
</p>

<p>
#nameserver 208.67.222.222 #nameserver 208.67.220.220
</p>

<p>
nameserver 8.8.8.8 nameserver 8.8.4.4
</p>

<p>
#nameserver 194.158.122.10 #nameserver 194.158.122.15
</p>

<p>
#nameserver 192.168.1.254
</p>

<div id="Sci-hub et DNS resolv.conf-Freebsd"><h2 id="Freebsd" class="header"><a href="#Sci-hub et DNS resolv.conf-Freebsd">Freebsd</a></h2></div>

<p>
/etc/resolv.conf est réécrit par dhclient. On met les nouveau DNS dans /etc/resolvconf.conf. Pour scihub :
</p>

<p>
&lt;pre&gt;name_servers=208.67.222.222
name_servers=208.67.220.220&lt;/pre&gt;
Puis
</p>

<p>
&lt;syntaxhighlight lang="shell"&gt;resolvconf -u&lt;/syntaxhighlight&gt;
</p>
<div id="musicpd"><h1 id="musicpd" class="header"><a href="#musicpd">musicpd</a></h1></div>

<p>
Changer le chemin en /data/music dans /usr/local/etc/musicpd.conf Puis
</p>

<p>
&lt;syntaxhighlight lang="shell"&gt;mkdir /var/mpd/.mpd/playlists
touch /var/mpd/.mpd/database
chown -R mpd /var/mpd/
service musicpd onestart&lt;/syntaxhighlight&gt;
</p>
<div id="KILL Windows as guest"><h1 id="KILL Windows as guest" class="header"><a href="#KILL Windows as guest">KILL Windows as guest</a></h1></div>

<p>
''Plante régulièrement =&amp;gt; virtualbox plutôt'' Guide <a href="https://github.com/churchers/vm-bhyve/wiki/Running-Windows">https://github.com/churchers/vm-bhyve/wiki/Running-Windows</a> <a href="https://srobb.net/vm-bhyve.html">https://srobb.net/vm-bhyve.html</a>
</p>

<p>
&lt;pre&gt;sudo pkg install vm-bhyve
sudo pkg install bhyve-firmware
sudo zfs create zroot/windows&lt;/pre&gt;
Ajouter à /etc/rc.conf vm<sub>enable</sub>=&amp;quot;YES&amp;quot; vm<sub>dir</sub>=&amp;quot;zfs:zroot/windows&amp;quot;
</p>

<p>
sudo vm init sudo cp ''usr/local/share/examples/vm-bhyve/windows.conf ''zroot/windows''.templates'' sudo vm switch add public re0 sudo vm create -t windows winguest
</p>

<p>
sudo pkg install tigervnc-viewer
</p>

<p>
sudo vm configure winguest
</p>

<p>
vm install myguest ~/Downloads/Win10<sub>20H2v2Frenchx64</sub>.iso vncviewer localhost:5900
</p>

<p>
Appuyer sur une touche pour lancer l'install
</p>

<div id="Latest au lieu de quartely"><h1 id="Latest au lieu de quartely" class="header"><a href="#Latest au lieu de quartely">Latest au lieu de quartely</a></h1></div>

<p>
/etc/pkg/FreeBSD.conf
</p>

<p>
&lt;pre&gt;# \(FreeBSD\)
#
</p>
<ol>
<li>
To disable this repository, instead of modifying or removing this file,

<li>
create a /usr/local/etc/pkg/repos/FreeBSD.conf file:

</ol>
<p>
#
</p>
<ol>
<li>
  mkdir -p /usr/local/etc/pkg/repos

<li>
  echo &amp;quot;FreeBSD: { enabled: no }&amp;quot; &amp;gt; /usr/local/etc/pkg/repos/FreeBSD.conf

</ol>
<p>
#
</p>

<p>
FreeBSD: {
  url: &amp;quot;pkg+<a href="http://pkg.FreeBSD.org/\({ABI}/latest&amp;quot;,">http://pkg.FreeBSD.org/\){ABI}/latest&amp;quot;,</a>
  mirror_type: &amp;quot;srv&amp;quot;,
  signature_type: &amp;quot;fingerprints&amp;quot;,
  fingerprints: &amp;quot;/usr/share/keys/pkg&amp;quot;,
  enabled: yes&lt;/pre&gt;
}
</p>

<div id="raspberry"><h1 id="raspberry" class="header"><a href="#raspberry">raspberry</a></h1></div>

<p>
loader.conf
</p>

<p>
&lt;pre&gt;# Configure USB OTG; see usb_template(4).
hw.usb.template=3
umodem_load=&amp;quot;YES&amp;quot;
</p>
<ol>
<li>
Multiple console (serial+efi gop) enabled.

</ol>
<p>
boot_multicons=&amp;quot;YES&amp;quot;
boot_serial=&amp;quot;YES&amp;quot;
</p>
<ol>
<li>
Disable the beastie menu and color

</ol>
<p>
beastie_disable=&amp;quot;YES&amp;quot;
loader_color=&amp;quot;NO&amp;quot;&lt;/pre&gt;
/etc/rc.conf
</p>

<p>
&lt;pre&gt;hostname=&amp;quot;generic&amp;quot;
#ifconfig_DEFAULT=&amp;quot;DHCP&amp;quot;
</p>
<ol>
<li>
Static ip for MAM

</ol>
<p>
ifconfig_genet0=&amp;quot;inet 192.168.1.78 netmask 255.255.255.0&amp;quot;
defaultrouter=&amp;quot;192.168.1.254&amp;quot;
sshd_enable=&amp;quot;YES&amp;quot;
sendmail_enable=&amp;quot;NONE&amp;quot;
sendmail_submit_enable=&amp;quot;NO&amp;quot;
sendmail_outbound_enable=&amp;quot;NO&amp;quot;
sendmail_msp_queue_enable=&amp;quot;NO&amp;quot;
growfs_enable=&amp;quot;YES&amp;quot;
ntpd_enable=&amp;quot;YES&amp;quot;
powerd_enable=&amp;quot;YES&amp;quot;
powerd_flags=&amp;quot;-r 1&amp;quot;&lt;/pre&gt;
/etc/ssh/sshd<sub>config</sub>
</p>

<p>
&lt;pre&gt;Port 666
PermitRootLogin no
AuthorizedKeysFile  .ssh/authorized_keys
Subsystem   sftp    /usr/libexec/sftp-server&lt;/pre&gt;
~/.rtorrent.rc
</p>

<p>
&lt;pre&gt;# Global upload and download rate in KiB. &amp;quot;0&amp;quot; for unlimited.
download_rate = 3500
upload_rate = 1000
</p>

<ol>
<li>
Default directory to save the downloaded torrents.

</ol>
<p>
#directory = /Data/Music
</p>

<ol>
<li>
Connectable on MAM

</ol>
<p>
network.port_range.set = 49164-49164
</p>
<ol>
<li>
Default session directory. Make sure you don't run multiple instance

<li>
of rtorrent using the same session directory. Perhaps using a

<li>
relative path?

</ol>
<p>
session =  ~/Downloads/session
</p>

<p>
## Watch a directory for new torrents, and stop those that have been
## deleted.
schedule = watch_directory_fantasy, 10, 10, &amp;quot;load.start=~/Downloads/torrents/books/fantasy/*.torrent,d.directory.set=/media/books/fantasy&amp;quot;
schedule = watch_directory_litterature, 10, 10, &amp;quot;load.start=~/Downloads/torrents/books/litterature/*.torrent,d.directory.set=/media/books/litterature&amp;quot;
schedule = watch_directory_medecine, 10, 10, &amp;quot;load.start=~/Downloads/torrents/books/medecine/*.torrent,d.directory.set=/media/books/medecine&amp;quot;
schedule = watch_directory_horror, 10, 10, &amp;quot;load.start=~/Downloads/torrents/books/horror/*.torrent,d.directory.set=/media/books/horror&amp;quot;
schedule = watch_directory_thriller, 10, 10, &amp;quot;load.start=~/Downloads/torrents/books/thriller/*.torrent,d.directory.set=/media/books/thriller&amp;quot;
schedule = watch_directory_history, 10, 10, &amp;quot;load.start=~/Downloads/torrents/books/history/*.torrent,d.directory.set=/media/books/history&amp;quot;
schedule = watch_directory_cs, 10, 10, &amp;quot;load.start=~/Downloads/torrents/books/cs/*.torrent,d.directory.set=/media/books/cs&amp;quot;
schedule = watch_directory_science, 10, 10, &amp;quot;load.start=~/Downloads/torrents/books/science/*.torrent,d.directory.set=/media/books/science&amp;quot;
</p>


<p>
schedule = untied_directory,5,5,stop_untied=
</p>

<ol>
<li>
Close torrents when diskspace is low.

</ol>
<p>
schedule = low_diskspace,5,60,close_low_diskspace=100M
</p>

<p>
encoding.add = utf8
</p>

<ol>
<li>
Use 'tmux -d rtorrent -s rtorrent ' instead

<li>
system.daemon.set = true&lt;/pre&gt;

</ol>
<p>
~/.config/fish/fish.config
</p>

<p>
&lt;pre&gt;# Vim binding
fish_vi_key_bindings
</p>

<ol>
<li>
Bepo bindings for vim

</ol>
<p>
for key in h l k j
</p>
<blockquote>
bind -e --user $key
bind -e --user -M visual $key
</blockquote>
<p>
end
</p>

<p>
bind --user c backward-char
bind --user r forward-char
bind --user s up-line
bind --user t down-line
</p>

<p>
bind --user -M visual c backward-char
bind --user -M visual r forward-char
bind --user -M visual s up-line
bind --user -M visual t down-line
</p>

<ol>
<li>
Alt-s uses doas instead of sudo

</ol>
<p>
for mode in insert default visual
</p>
<blockquote>
bind --user -s -M $mode \es __fish_prepend_doas
</blockquote>
<p>
end
</p>

<p>
alias tma=&amp;quot;tmux a -d -t&amp;quot;
alias tms=&amp;quot;tmux new-session -s&amp;quot;
alias ttorr=&amp;quot;tmux a -d -t rtorrernt&amp;quot;
</p>

<ol>
<li>
Allow tramp connection from emacs

</ol>
<p>
if test &amp;quot;$TERM&amp;quot; = &amp;quot;dumb&amp;quot;
</p>
<blockquote>
exec sh
</blockquote>
<p>
end&lt;/pre&gt;
</p>
<div id="poudrier config"><h1 id="poudrier config" class="header"><a href="#poudrier config">poudrier config</a></h1></div>

<p>
/usr/local/etc/poudriere.conf
</p>

<p>
&lt;pre&gt;ZPOOL=zroot
ZROOTFS=/poudriere
FREEBSD_HOST=<a href="ftp://ftp.freebsd.org">ftp://ftp.freebsd.org</a>
RESOLV_CONF=/etc/resolv.conf
BASEFS=/usr/local/poudriere
USE_PORTLINT=no
USE_TMPFS=yes
DISTFILES_CACHE=/usr/ports/distfiles
SVN_HOST=svn.FreeBSD.org
CCACHE_DIR=/usr/obj/ccache
</p>
<ol>
<li>
By default : 1 build per CPU but 1 thread per build.

<li>
for large ports, this is not enough

</ol>
<p>
ALLOW_MAKE_JOBS=yes&lt;/pre&gt;
</p>

</body>
</html>
