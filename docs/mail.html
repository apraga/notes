<!DOCTYPE html>
<html>
<head>
<link rel="Stylesheet" type="text/css" href="style.css">
<title>mail</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<p>
Today, we will see how to get mails, read them, and answer them, inside a terminal. We will need four utilities for that :
</p>

<ul>
<li>
one to synchronize our local mails with the server : &lt;code&gt;mbsync&lt;/code&gt;,

<li>
a mail client for viewing them : emacs with &lt;code&gt;notmuch&lt;/code&gt;

<li>
an agent for sending mails : &lt;code&gt;msmtp&lt;/code&gt; a good choice (or sendmail, which should be installed by default on most Linux and BSD distribution )

</ul>

<p>
Install each of this utilities according to the usual way of your distribution. The following tutorial assumes you have two accounts, one of them being Gmail.
</p>

<div id="Mbsync and Gmail"><h2 id="Mbsync and Gmail" class="header"><a href="#Mbsync and Gmail">Mbsync and Gmail</a></h2></div>

<p>
Here we will configure a gmail account using &lt;code&gt;~/.msmtprc&lt;/code&gt;. Let's break down the configuration file. First, for increased security, generate an app password using <a href="https://myaccount.google.com/apppasswords">https://myaccount.google.com/apppasswords</a> and encrypt it with gpg:
</p>

<p>
&lt;pre&gt;#---------------------------------
</p>
<ol>
<li>
Gmail

</ol>
<p>
#---------------------------------
IMAPAccount gmail
</p>
<ol>
<li>
Address to connect to

</ol>
<p>
Host imap.gmail.com
User alexis.praga@gmail.com
PassCmd &amp;quot;gpg2 -q --for-your-eyes-only --no-tty -d ~/.gmailpass.gpg&amp;quot;
</p>
<ol>
<li>
Use SSL

</ol>
<p>
SSLType IMAPS
CertificateFile /usr/local/share/certs/ca-root-nss.crt
</p>

<p>
IMAPStore gmail-remote
Account gmail&lt;/pre&gt;
Then define the folders for your mail. &lt;code&gt;~mail/gmail&lt;/code&gt; contains an Inbox and an Archive folder. It must be of the &lt;code&gt;maildir&lt;/code&gt; format. Using the fish shell syntax:
</p>

<p>
&lt;syntaxhighlight lang="shell"&gt;for i in cur new tmp
  mkdir -p ~/mail/gmail/inbox/$i
  mkdir -p ~/mail/gmail/archive/$i
end&lt;/syntaxhighlight&gt;
Now, return to &lt;code&gt;~/.mbsyncrc&lt;/code&gt;:
</p>

<p>
&lt;pre&gt;MaildirStore gmail-local
</p>
<ol>
<li>
Important: we need to be able to move files. The &amp;quot;native&amp;quot; setting results in duplicates and errors...

</ol>
<p>
AltMap yes
Subfolders Verbatim
</p>
<ol>
<li>
The trailing &amp;quot;/&amp;quot; is important

</ol>
<p>
Path ~/mail/gmail/
Inbox ~/mail/gmail/inbox&lt;/pre&gt;
Then the hard part: how to synchronize folders with gmail ? I've chosen to put incoming mail in &lt;code&gt;inbox&lt;/code&gt; and everything else in &lt;code&gt;archive&lt;/code&gt;
</p>

<p>
&lt;pre&gt;# Exclude everything under the internal [Gmail] folder, except the interesting folders
</p>
<ol>
<li>
ALl (and I mean all) mail is in All mail.

<li>
With this setup, we have duplicates in inbox and in all mail (that's ok, should not be much)

<li>
There is no need for sent folder as it is also in all mail...

<li>
We also need deleted messages because the iPhone do not delete mail but create

<li>
this label instead... So we have to get it here, delete et sync with the

<li>
server

</ol>
<p>
Channel gmail-default
Far <span id="Mbsync and Gmail-gmail-remote"></span><span class="tag" id="gmail-remote">gmail-remote</span>
Near <span id="Mbsync and Gmail-gmail-local"></span><span class="tag" id="gmail-local">gmail-local</span>
</p>
<ol>
<li>
Select some mailboxes to sync

</ol>
<p>
Patterns &amp;quot;INBOX&amp;quot;
Create Near
</p>
<ol>
<li>
Save the synchronization state files in the relevant directory

</ol>
<p>
SyncState *
</p>

<ol>
<li>
Name translation

</ol>
<p>
Channel gmail-archive
Far :gmail-remote:&amp;quot;[Gmail]/All Mail&amp;quot;
Near :gmail-local:archive
Create Near
SyncState *
</p>

<p>
Channel gmail-trash
Far :gmail-remote:&amp;quot;Deleted Messages&amp;quot;
Near :gmail-local:trash
Create Near
SyncState *
</p>

<ol>
<li>
Get all the channels together into a group.

</ol>
<p>
Group googlemail
Channel gmail-default
Channel gmail-archive
Channel gmail-trash&lt;/pre&gt;
A second account can be set the same way :
</p>

<p>
&lt;pre&gt;#---------------------------------
</p>
<ol>
<li>
Free

</ol>
<p>
#---------------------------------
IMAPAccount free
</p>
<ol>
<li>
Address to connect to

</ol>
<p>
Host imap.free.fr
User alexis.praga@free.fr
</p>
<ol>
<li>
The file is encrypted with &amp;quot;gpg -e&amp;quot;

</ol>
<p>
PassCmd &amp;quot;gpg2 -q --for-your-eyes-only --no-tty -d ~/.freepass.gpg&amp;quot;
</p>
<ol>
<li>
Use SSL

</ol>
<p>
SSLType IMAPS
CertificateFile /usr/local/share/certs/ca-root-nss.crt
</p>

<p>
IMAPStore free-remote
Account free
</p>

<p>
MaildirStore free-local
</p>
<ol>
<li>
Important: we need to be able to move files. The &amp;quot;native&amp;quot; setting results in duplicates and errors...

</ol>
<p>
AltMap yes
Subfolders Verbatim
</p>
<ol>
<li>
The trailing &amp;quot;/&amp;quot; is important

</ol>
<p>
Path ~/mail/free/
Inbox ~/mail/free/inbox
</p>

<p>
Channel free-default
Far <span id="Mbsync and Gmail-free-remote"></span><span class="tag" id="free-remote">free-remote</span>
Near <span id="Mbsync and Gmail-free-local"></span><span class="tag" id="free-local">free-local</span>
Patterns &amp;quot;INBOX&amp;quot;
Create Near
SyncState *
</p>

<ol>
<li>
Name translation

</ol>
<p>
Channel free-archive
Far :free-remote:&amp;quot;Archive&amp;quot;
Near :free-local:archive
Create Near
SyncState *
</p>

<ol>
<li>
Name translation

</ol>
<p>
Channel free-sent
Far :free-remote:&amp;quot;Sent&amp;quot;
Near :free-local:sent
Create Near
SyncState *
</p>

<ol>
<li>
Get all the channels together into a group.

</ol>
<p>
Group freemail
Channel free-default
Channel free-archive&lt;/pre&gt;
</p>
<div id="Msmtp"><h2 id="Msmtp" class="header"><a href="#Msmtp">Msmtp</a></h2></div>

<p>
To send mail, I use the gmail account for that :
</p>

<p>
&lt;pre&gt;# Set default values for all following accounts.
defaults
auth           on
tls            on
tls_trust_file /usr/local/share/certs/ca-root-nss.crt
logfile        ~/.msmtp.log
</p>

<ol>
<li>
Gmail

</ol>
<p>
account        gmail
host           smtp.gmail.com
port           587
from           horse1@gmail.com
user           john.doe
password       XXXXXXX
</p>

<ol>
<li>
Set a default account

</ol>
<p>
account default : gmail&lt;/pre&gt;
Change the permissions :
</p>

<p>
&lt;syntaxhighlight lang="shell"&gt;$ chmod 600 ~/.msmtprc&lt;/syntaxhighlight&gt;
Then, you can try sending mail with the following command :
</p>

<p>
&lt;syntaxhighlight lang="shell"&gt;$ cat test.mail | msmtp -a default account1@gmail.com &lt;/syntaxhighlight&gt;
where test.mail is an simple file like this one (there must be an empty line after the subject):
</p>

<p>
&lt;pre class="example"&gt;To: account1@gmail.com
From: fake@gmail.com
Subject: Test &amp;lt;br/&amp;gt; 
</p>

<p>
Hello !&lt;/pre&gt;
</p>
<div id="Notmuch and emacs"><h2 id="Notmuch and emacs" class="header"><a href="#Notmuch and emacs">Notmuch and emacs</a></h2></div>

<p>
Notmuch is an awesome tool to manage your mail. Basically, it does not touch your mail but rather operates on tags. So an incoming mail will be tagged as &lt;code&gt;inbox&lt;/code&gt; and if you delete it, it will be replaced by the &lt;code&gt;deleted&lt;/code&gt; tag. It allows for fast indexing and quick search of your mail. The only drawback is that it does '''not''' move your mail. So deleting for real must be done manually.
</p>

<p>
Anway, it's awesome and you should use it in 2021 !
</p>

<p>
Configuration is pretty straightforward. The first time, run
</p>

<p>
&lt;pre&gt;notmuch
notmuch new&lt;/pre&gt;
and follow the instructions.
</p>

<p>
Then I have a script running as a cron job to synchronize my mail and move mails in the proper folder (&lt;code&gt;inbox&lt;/code&gt;, &lt;code&gt;archive&lt;/code&gt;) or delete it :
</p>

<p>
&lt;pre&gt;#!/usr/local/bin/fish
</p>

<ol>
<li>
Combine mbsync and notmuch because mbsync may fail and we still want notmuch to run (as we keep getting quota errors)

<li>
So we must have the two command here

</ol>

<p>
mbsync -a
</p>

<p>
set args --output=files --format=text0
</p>

<ol>
<li>
Tagsent mails (by default, there are not tagged)

</ol>
<p>
set filter &amp;quot;(folder:gmail/inbox or folder:free/inbox or tag:inbox) and from:\&amp;quot;Alexis Praga\&amp;quot;&amp;quot;
notmuch tag +sent +archived -inbox --  $filter
</p>

<ol>
<li>
Move archived mail from inbox to archive folder

</ol>
<p>
set filter tag:archived folder:gmail/inbox
notmuch search \(args \)filter  | xargs -0 -J {} mv {} ~/mail/gmail/archive/cur
</p>

<p>
set filter tag:archived folder:free/inbox
notmuch search \(args \)filter  | xargs -0 -J {} mv {} ~/mail/free/archive/cur
</p>

<ol>
<li>
Really delete &amp;quot;deleted messages&amp;quot; from gmail

</ol>
<p>
set filter &amp;quot;folder:gmail/trash&amp;quot;
notmuch tag +deleted --  $filter
</p>

<ol>
<li>
delete mails as notmuch cannot do it

</ol>
<p>
set filter &amp;quot;(folder:free/inbox or folder:gmail/inbox or folder:gmail/trash) and tag:deleted&amp;quot;
notmuch search \(args \)filter  | xargs -0 -J {} mv {} ~/mail/trash/cur
</p>

<ol>
<li>
Get new mail

</ol>
<p>
notmuch new
</p>

<p>
‚ùØ crontab -l
MAILTO=&amp;quot;&amp;quot;
*/5 * * * * $HOME/scripts/mbsync_notmuch.sh&lt;/pre&gt;
Then I can read the email inside emacs with the &lt;code&gt;notmuch&lt;/code&gt; plugin.
</p>

<div id="What about gnus ?"><h2 id="What about gnus ?" class="header"><a href="#What about gnus ?">What about gnus ?</a></h2></div>

<p>
I've tried it two times because the concept was appealing: manage your mail as a newserver is cool. The major drawback is the lack of integration for notmuch. You can make it work with &lt;code&gt;mairix&lt;/code&gt; but its super slow.
</p>

</body>
</html>
